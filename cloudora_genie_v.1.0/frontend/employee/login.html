<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Employee Login - Cloudora Genie</title>

<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="./login.css">

</head>

<body>

<header class="site-header">
  <div class="brand">Cloudora Genie Employee</div>
  <div class="controls">
    <select id="langSelect"></select>
    <button id="speakBtn" class="btn-mini">ðŸ”Š</button>
  </div>
</header>

<main class="container fade-in">

  <div class="login-box">
    <h2 id="loginTitle" class="login-title">Employee Login</h2>

    <p class="login-sub">Use your Employee ID & Password</p>

    <div class="input-group">
      <label id="lblEmpID">Employee ID</label>
      <input id="empID" placeholder="EMP-XXXXX" required>
      <div class="error" id="errID">Employee ID is required</div>
    </div>

    <div class="input-group">
      <label id="lblPassword">Password</label>
      <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
      <div class="error" id="errPass">Password cannot be empty</div>
    </div>

    <button id="loginBtn" class="btn-primary">Login</button>

    <div id="loginError" class="error" style="text-align:center;margin-top:10px;"></div>

  </div>

</main>

<!-- âœ… LOAD SUPABASE SDK FIRST -->
<script src="../api/supabase.min.js"></script>

<!-- âœ… THEN GLOBAL ENGINE -->
<script src="../global.js"></script>

<script>
// -------------------------------------
// LANGUAGE ENGINE
// -------------------------------------
initializeLanguageSelector();
applyTranslations();

// Speech
document.getElementById("speakBtn").onclick = () =>
  speak("Please login using your employee ID and password");


// -------------------------------------
// LOGIN HANDLER
// -------------------------------------
document.getElementById("loginBtn").onclick = async () => {

  const empID = document.getElementById("empID").value.trim();
  const pass = document.getElementById("password").value.trim();

  let valid = true;

  if (!empID) { document.getElementById("errID").style.display = "block"; valid = false; }
  else document.getElementById("errID").style.display = "none";

  if (!pass) { document.getElementById("errPass").style.display = "block"; valid = false; }
  else document.getElementById("errPass").style.display = "none";

  if (!valid) return;

  // -------------------------------------
  // API CALL
  // -------------------------------------
  try {
    const res = await fetch(CONFIG.BACKEND + "/api/job/login", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ employee_id: empID, password: pass })
    });

    const j = await res.json();

    if (!j.ok) {
      document.getElementById("loginError").innerText = j.error || "Invalid credentials";
      return;
    }

    // SAVE SESSION
    localStorage.setItem("employee_id", j.employee.employee_id);
    localStorage.setItem("employee_name", j.employee.name);
    localStorage.setItem("employee_department", j.employee.department);

    // REDIRECT
    window.location.href = "./dashboard.html";

  } catch (e) {
    document.getElementById("loginError").innerText = "Network error, try again.";
  }

};
</script>

</body>
</html>
