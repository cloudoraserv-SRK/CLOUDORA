<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Training System - Cloudora</title>

<link rel="stylesheet" href="../style.css">

<style>
.container-box {
  background: #fff;
  max-width: 800px;
  margin: 30px auto;
  padding: 25px;
  border-radius: 18px;
  box-shadow: 0 8px 22px rgba(0,0,0,0.09);
}
.module-card {
  padding: 18px;
  background: #eef2ff;
  margin-top: 15px;
  border-radius: 12px;
}
.module-card button {
  margin-top: 10px;
  margin-right: 10px;
}
.question-box {
  padding: 15px;
  background: #f3f4f6;
  border-radius: 12px;
  margin-top: 15px;
}
.option {
  padding: 12px;
  margin-top: 10px;
  background: #fff;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  cursor: pointer;
}
.option:hover {
  background: #e0e7ff;
}
</style>
</head>

<body>

<header class="site-header">
  <div class="brand">Training System</div>
  <button class="btn-mini" onclick="goBack()">‚Üê Back</button>
</header>

<main class="container fade-in">

  <!-- LESSON VIEWER -->
  <div class="container-box" id="lessonBox" style="display:none;">
    <h2 id="lessonTitle"></h2>
    <div id="lessonContent" style="white-space:pre-line; margin-top:15px;"></div>

    <button onclick="closeLesson()" class="btn-primary" style="margin-top:20px;">Close</button>
  </div>

  <!-- MODULE LIST -->
  <div class="container-box" id="moduleBox">
    <h2>Training Modules</h2>
    <div id="moduleList">Loading modules...</div>
  </div>

  <!-- QUIZ BOX -->
  <div class="container-box" id="quizBox" style="display:none;">
    <h2 id="quizTitle"></h2>
    <div id="questionArea"></div>
    <button id="submitBtn" class="btn-primary" style="margin-top:20px;">Submit Quiz</button>
  </div>

</main>

<script src="../api/supabase.min.js"></script>
<script src="../global.js"></script>

<script>
const empID = localStorage.getItem("employee_id");
if (!empID) window.location.href = "./login.html";

function goBack(){
  window.location.href = "./dashboard.html";
}

let CURRENT_MODULE = null;
let QUESTIONS = [];
let ANSWERS = {};


// ----------------------------------------------------------
// LOAD ALL TRAINING MODULES
// ----------------------------------------------------------
async function loadModules() {
  const res = await fetch(CONFIG.BACKEND + "/api/training/modules");
  const j = await res.json();

  if (!j.ok) {
    moduleList.innerHTML = "Error loading modules";
    return;
  }

  moduleList.innerHTML = "";

  j.modules.forEach(m => {
    moduleList.innerHTML += `
      <div class="module-card">
        <b>${m.title}</b><br>
        <small>${m.description}</small><br><br>

        <button class="btn-small" onclick="openLesson(${m.id})">üìò Read Lesson</button>
        <button class="btn-small" onclick="startModule(${m.id}, '${m.title}')">üìù Take Quiz</button>
      </div>
    `;
  });
}


// ----------------------------------------------------------
// OPEN LESSON READER
// ----------------------------------------------------------
async function openLesson(id) {
  const res = await fetch(CONFIG.BACKEND + "/api/training/content?module_id=" + id);
  const j = await res.json();

  if (!j.ok) {
    alert("Lesson not found!");
    return;
  }

  // Switch UI
  moduleBox.style.display = "none";
  quizBox.style.display = "none";
  lessonBox.style.display = "block";

  lessonTitle.innerText = j.content.title;
  lessonContent.innerText = j.content.content;
}

function closeLesson() {
  lessonBox.style.display = "none";
  moduleBox.style.display = "block";
}


// ----------------------------------------------------------
// START QUIZ
// ----------------------------------------------------------
async function startModule(id, title) {
  CURRENT_MODULE = id;

  const res = await fetch(CONFIG.BACKEND + "/api/training/questions?module_id=" + id);
  const j = await res.json();

  if (!j.ok) return;

  QUESTIONS = j.questions;
  ANSWERS = {};

  // Switch UI
  moduleBox.style.display = "none";
  lessonBox.style.display = "none";
  quizBox.style.display = "block";

  quizTitle.innerText = title;
  renderQuestions();
}


// ----------------------------------------------------------
// RENDER QUESTIONS
// ----------------------------------------------------------
function renderQuestions() {
  questionArea.innerHTML = "";

  QUESTIONS.forEach((q, i) => {
    questionArea.innerHTML += `
      <div class="question-box">
        <b>Q${i+1}:</b> ${q.question}

        <div class="option" onclick="selectOption(${q.id}, 'A')">${q.option_a}</div>
        <div class="option" onclick="selectOption(${q.id}, 'B')">${q.option_b}</div>
        <div class="option" onclick="selectOption(${q.id}, 'C')">${q.option_c}</div>
        <div class="option" onclick="selectOption(${q.id}, 'D')">${q.option_d}</div>
      </div>
    `;
  });
}

function selectOption(qid, opt) {
  ANSWERS[qid] = opt;
}


// ----------------------------------------------------------
// SUBMIT QUIZ
// ----------------------------------------------------------
submitBtn.onclick = async () => {
  const res = await fetch(CONFIG.BACKEND + "/api/training/submit", {
    method: "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      employee_id: empID,
      module_id: CURRENT_MODULE,
      answers: ANSWERS
    })
  });

  const j = await res.json();
  alert("Quiz submitted! Score: " + j.score + "/" + j.total);

  quizBox.style.display = "none";
  moduleBox.style.display = "block";
};


// INITIAL LOAD
loadModules();
</script>

</body>
</html>
