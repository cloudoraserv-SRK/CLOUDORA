<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Candidate Agreement</title>

<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="./job.css">

<style>
/* Minimal styles for the agreement UI */
.agreement-box {
  background: #ffffff;
  padding: 28px;
  border-radius: 18px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.06);
  max-width: 980px;
  margin: 36px auto;
  font-size: 15px;
  line-height: 1.6;
}
.agreement-title { font-size: 22px; font-weight: 800; text-align:center; margin-bottom:8px; }
.notice { background:#fef3c7; padding:12px; border-radius:10px; margin-bottom:18px; border-left:5px solid #f59e0b; font-weight:600; }
.controls { display:flex; gap:8px; align-items:center; }
.next-btn { margin-top:18px; width:100%; background:#6366f1; border:none; padding:12px; font-size:16px; font-weight:600; color:white; border-radius:10px; cursor:pointer; }
.next-btn[disabled] { background:#9ca3af; cursor:not-allowed; }
.small-muted { color:#6b7280; font-size:13px; margin-top:10px; }
.status { margin-top:12px; padding:10px; border-radius:8px; display:none; }
.status.error { background:#fee2e2; color:#991b1b; display:block; }
.status.success { background:#ecfdf5; color:#065f46; display:block; }
.progress { display:inline-block; margin-left:8px; vertical-align:middle; }
</style>
</head>
<body>

<header class="site-header">
  <div class="brand">Cloudora Genie</div>
  <div class="controls">
    <select id="langSelect" aria-label="Select language"></select>
    <button id="speakBtn" class="btn-mini" title="Read aloud">üîä</button>
  </div>
</header>

<main class="container fade-in">

  <div class="agreement-box" role="main" aria-labelledby="title">
    <div id="title" class="agreement-title">Candidate Agreement</div>

    <div id="notice" class="notice">Please read the agreement carefully before continuing.</div>

    <div id="agreementContent" aria-live="polite"></div>

    <div style="margin-top:20px; display:flex; align-items:center; gap:10px;">
      <input type="checkbox" id="agreeCheck" aria-label="I agree to the terms">
      <label id="agreeLabel" for="agreeCheck">I have read and agree to all terms</label>
    </div>

    <button id="nextBtn" disabled class="next-btn">Proceed</button>

    <div id="statusMsg" class="status" role="status" aria-live="assertive"></div>
    <div class="small-muted">By proceeding you accept Cloudora's trial terms and policies.</div>
  </div>

</main>

<!-- 1) Supabase SDK MUST load before global.js -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<!-- 2) Your global.js (exposes CONFIG, I18N, speak(), initializeLanguageSelector(), applyTranslations()) -->
<script src="../global.js"></script>

<!-- 3) Page script with full functionality -->
<script>
/* Agreement page script ‚Äî complete and defensive */

(function () {
  // Elements
  const agreeCheck = document.getElementById('agreeCheck');
  const nextBtn = document.getElementById('nextBtn');
  const statusMsg = document.getElementById('statusMsg');
  const agreementContent = document.getElementById('agreementContent');

  // Read lead UID from URL
  const params = new URLSearchParams(window.location.search);
  const lead_uid = params.get('lead') || '';

  // Full agreement texts (concise version; you can expand)
  const AGREEMENT = {
    en: `
<h3>1. Overview</h3>
<p>You are applying for a 7-day trial assignment under Cloudora Genie workforce program. During this trial, no salary is provided. However, performance-based incentives may be given based on output.</p>

<h3>2. Departments Covered</h3>
<ul>
  <li><b>Telecalling ‚Äì Lead Generation</b>
    <ul>
      <li>Call leads as assigned by the system.</li>
      <li>Update CRM after every call.</li>
      <li>No abusive or unprofessional tone allowed.</li>
    </ul>
  </li>
  <li><b>Sales ‚Äì Domestic / International</b>
    <ul>
      <li>Handle warm leads transferred by telecalling team.</li>
      <li>Explain Cloudora services clearly.</li>
    </ul>
  </li>
</ul>

<h3>3. Attendance & Shifts</h3>
<p>Log in daily using Cloudora Genie dashboard. Choose preferred shift during application.</p>

<h3>4. Performance Rules</h3>
<ul><li>Leads must be handled professionally and logged correctly.</li><li>Fake updates or false entries may lead to termination.</li></ul>

<h3>5. Privacy & Data</h3>
<p>Leads and CRM data are confidential ‚Äî do not share.</p>

<h3>8. Declaration</h3>
<p>By continuing, you agree that information submitted is correct and you voluntarily join this 7-day trial program.</p>
`,
    hi: `
<h3>1. ‡§™‡§∞‡§ø‡§ö‡§Ø</h3>
<p>‡§Ü‡§™ Cloudora Genie ‡§ï‡•á 7-‡§¶‡§ø‡§® ‡§ü‡•ç‡§∞‡§æ‡§Ø‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§µ‡•á‡§§‡§® ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ‡•§ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§á‡§Ç‡§∏‡•á‡§Ç‡§ü‡§ø‡§µ ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>

<h3>2. ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§µ‡§ø‡§≠‡§æ‡§ó</h3>
<p>‡§ü‡•á‡§≤‡•Ä‡§ï‡•â‡§≤‡§ø‡§Ç‡§ó ‡§î‡§∞ ‡§∏‡•á‡§≤‡•ç‡§∏ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à‡§Ç‡•§</p>

<h3>3. ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</h3>
<p>Cloudora Genie ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§∞‡•ã‡§ú‡§º ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§</p>

<h3>8. ‡§ò‡•ã‡§∑‡§£‡§æ</h3>
<p>‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§ï‡§∞ ‡§Ü‡§™ ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§¶‡•Ä ‡§ó‡§à ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§π‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§Ü‡§™ ‡§ü‡•ç‡§∞‡§æ‡§Ø‡§≤ ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§ó ‡§≤‡•á ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§</p>
`
  };

  // Utility: show status messages
  function showStatus(type, text) {
    statusMsg.className = 'status ' + (type === 'error' ? 'error' : 'success');
    statusMsg.innerText = text;
    statusMsg.style.display = 'block';
  }
  function clearStatus() {
    statusMsg.style.display = 'none';
    statusMsg.innerText = '';
  }

  // Render agreement text based on CONFIG.LANG (global.js provides applyTranslations + initializeLanguageSelector)
  function renderAgreement() {
    const lang = (window.CONFIG && window.CONFIG.LANG) ? window.CONFIG.LANG : 'en';
    agreementContent.innerHTML = AGREEMENT[lang] || AGREEMENT['en'];
    document.getElementById('title').innerText = lang === 'hi' ? '‡§â‡§Æ‡•ç‡§Æ‡•Ä‡§¶‡§µ‡§æ‡§∞ ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß' : 'Candidate Agreement';
    document.getElementById('notice').innerText = lang === 'hi'
      ? '‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§∏‡§Æ‡§ù‡•å‡§§‡•á ‡§ï‡•ã ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§∏‡•á ‡§™‡§¢‡§º‡•á‡§Ç‡•§'
      : 'Please read the agreement carefully before continuing.';
    document.getElementById('agreeLabel').innerText = lang === 'hi'
      ? '‡§Æ‡•à‡§Ç‡§®‡•á ‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§™‡§¢‡§º ‡§≤‡§ø‡§è ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§∏‡§π‡§Æ‡§§ ‡§π‡•Ç‡§Å'
      : 'I have read and agree to all terms';
  }

  // Init language selector + translation (global functions)
  try {
    if (typeof initializeLanguageSelector === 'function') initializeLanguageSelector();
    if (typeof applyTranslations === 'function') applyTranslations();
  } catch(e) { console.warn('lang init failed', e); }

  renderAgreement();

  // Language selector event (keep global sync)
  const ls = document.getElementById('langSelect');
  if (ls) {
    ls.onchange = () => {
      try {
        window.CONFIG.LANG = ls.value;
        localStorage.setItem('lang', ls.value);
        renderAgreement();
      } catch (e) { /* ignore */ }
    };
  }

  // TTS button
  document.getElementById('speakBtn').onclick = () => {
    // read visible agreement content (brief)
    const summary = agreementContent.innerText.slice(0, 800);
    if (typeof speak === 'function') speak(summary);
  };

  // Checkbox toggle
  agreeCheck.onchange = () => {
    nextBtn.disabled = !agreeCheck.checked;
    clearStatus();
  };

  // Helper: call onboarding log (non-blocking)
  async function logOnboarding(step, answer = null) {
    try {
      await fetch(`${CONFIG.BACKEND}/api/onboarding/log`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ step, answer, applicationId: lead_uid || null })
      });
    } catch (e) {
      // ignore logging errors
      console.warn('onboarding log failed', e);
    }
  }

  // Main: Proceed button handler (save agreement and redirect)
  nextBtn.onclick = async () => {
    clearStatus();

    if (!lead_uid) {
      showStatus('error', 'Invalid lead. Please restart the application flow.');
      return;
    }

    // disable UI while saving
    nextBtn.disabled = true;
    agreeCheck.disabled = true;
    showStatus('success', 'Saving your acceptance...');

    try {
      const resp = await fetch(`${CONFIG.BACKEND}/api/job/agreement-accept`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lead_uid })
      });

      const out = await resp.json();
      console.log('agreement-accept response', out);

      if (!out.ok) {
        // If backend returned error message, show it
        showStatus('error', out.error || 'Failed to save agreement. Try again.');
        // re-enable UI
        nextBtn.disabled = false;
        agreeCheck.disabled = false;
        return;
      }

      // log onboarding step (non-blocking)
      logOnboarding('agreement_accepted', JSON.stringify({ lead_uid }));

      // success -> redirect to generate-id
      showStatus('success', 'Agreement saved. Redirecting to generate employee ID‚Ä¶');
      setTimeout(() => {
        window.location.href = `./generate-id.html?lead=${encodeURIComponent(lead_uid)}`;
      }, 600);

    } catch (err) {
      console.error('agreement accept network error', err);
      showStatus('error', 'Network error while saving agreement. Please try again.');
      nextBtn.disabled = false;
      agreeCheck.disabled = false;
    }
  };

  // Accessibility: allow Enter key on checkbox/label to toggle and enable button
  document.addEventListener('keydown', (e) => {
    if ((e.key === 'Enter' || e.key === ' ') && document.activeElement === agreeCheck) {
      agreeCheck.checked = !agreeCheck.checked;
      agreeCheck.dispatchEvent(new Event('change'));
      e.preventDefault();
    }
  });

})();
</script>

</body>
</html>
